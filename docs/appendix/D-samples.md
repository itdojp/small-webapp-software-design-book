---
title: "Appendix D: 記入例（ランニング例の完成形）"
permalink: /appendix/D-samples/
show_nav: true
prev: /appendix/B-templates/
next: /appendix/E-glossary/
---

# Appendix D: 記入例（ランニング例の完成形）

Appendix B のテンプレを、ランニング例（小規模タスク管理）に対して記入した例です。テンプレ番号（B-1..B-8）に対応する順で掲載しています。

対象: 「タスク割り当て + 通知（メール）」

| テンプレ | 記入例 | ねらい |
| --- | --- | --- |
| B-1 | D-1 | 要求（なぜやるか）を KPI で固定する |
| B-2 | D-2 | 要件（Shall）を実装から分離して列挙する |
| B-3 | D-3 | 仕様（外部観測の振る舞い）を曖昧さなく定義する |
| B-5 | D-4 | 設計（内部構造）を最小でアウトライン化する |
| B-4 | D-5 | S/D/V で依存の痛みを半定量化する |
| B-6 | D-6 | 変更理由（Change Drivers）で「なぜ今」を揃える |
| B-7 | D-7 | ADR で重大な分岐を最小記録する |
| B-8 | D-8 | テスト配分（単体/統合/E2E）を合意する |

## D-1. 要求（Needs / Goals）の記入例（B-1）

### テーマ: 「タスク割り当て + 通知（メール）」

#### 背景/課題（As-Is）

- 何が起きているか（事実）: タスクが割り当てられても担当者が気づかず、着手が遅れる
- 誰が困っているか: 管理者（進捗管理・調整コスト）、担当者（見落としによる期限超過）
- 放置するとどうなるか（損失/機会損失）: 期限超過の増加、リマインド/再割り当ての手間、監査（誰が割り当てたか）の不備

#### 目的（Goals / To-Be）

- 目標状態（業務/体験）: 管理者の割り当てが担当者に伝わり、期限内に着手/完了できる
- 期限（いつまでに）: 次のリリースまで（例）

#### KPI（測定）

| 指標 | 現状 | 目標 | 測定方法 | 備考 |
| --- | --- | --- | --- | --- |
| 割り当て後 24h 未着手率 | 30%（例） | 10%（例） | `assignedAt`→`in_progress` までの差分を集計 | タスク種別で分ける余地 |
| 期限超過率 | 15%（例） | 5%（例） | `dueAt` と `doneAt` を集計 | 期限ルール変更で変動 |
| 通知失敗の検知遅延 | 2日（例） | 当日（例） | 失敗ログ/アラートの検知時間を集計 | 運用体制に依存 |

#### スコープ/非ゴール

- 含む:
  - 管理者による担当者割り当て
  - 担当者への通知（メール）
  - 失敗時の検知と再送方針の明文化
- 含まない（非ゴール）:
  - 通知チャネルの多重化（Slack 等）
  - 高度な配信保証（厳密な exactly-once）
  - 既読・承認フロー（通知に対するリアクション管理）

#### 制約/前提

- 体制: 単一チーム、単一リポジトリ
- 外部I/F: メール送信はネットワーク越しの外部サービス
- 運用: 通知失敗は業務影響を持つため、検知手段が必要

## D-2. 要件（Requirements / Shall）の記入例（B-2）

### スコープ

- 含む:
  - タスクに担当者を割り当てできる
  - 割り当て時に担当者へ通知できる
  - 割り当て操作の監査ができる
- 含まない（非ゴール）:
  - 通知チャネルの多重化（Slack 等）
  - 高度な配信保証（厳密な exactly-once）

### 機能要件（Shall）

| ID | Shall（要件） | 根拠（要求/KPI） | 優先度 | 備考 |
| --- | --- | --- | --- | --- |
| R-1 | システムは管理者がタスクに担当者を割り当てできること | 未着手率の低減 | Must | |
| R-2 | システムは権限により割り当て操作を制御すること（管理者のみ） | セキュリティ/監査 | Must | |
| R-3 | システムは割り当て（誰が/いつ/誰に/どのタスク）を記録できること | 監査 | Should | 監査要件次第で Must |
| R-4 | システムは割り当て時に担当者へ通知できること | 未着手率の低減 | Must | 通知チャネルは仕様で固定 |
| R-5 | システムは通知が失敗しても割り当ての確定を妨げないこと | 業務継続 | Must | 失敗は検知可能であること |
| R-6 | システムは通知失敗を運用で検知できること | 検知遅延の短縮 | Must | ログ/メトリクス/アラート |
| R-7 | システムは存在しないタスクへの割り当てを失敗として扱うこと | 品質 | Must | エラー形式は仕様で定義 |

### 非機能（最小合意）

- 性能: 割り当て操作は通常時 1 秒以内（例: p95）で完了する
- 可用性: メンテ時間帯を除き稼働（SLA/SLO は将来導入なら「未定」でもよい）
- セキュリティ/権限: 管理者/一般ユーザーを識別し、割り当ては管理者のみに制限する
- 監査/ログ: 割り当て（誰が/いつ/誰に/どのタスク）を検索可能な形で残す
- 運用（アラート/リトライ/バックアップ）: 通知失敗が検知でき、再送方針（手動/自動）が明文化されている

### 未決/リスク

- 通知失敗時の再送方式（手動/自動、再送回数、間隔）
- 監査ログの保存期間・閲覧権限
- 同時更新（競合）の扱い（後勝ち/排他/409 など）

## D-3. 仕様（Specification / Behavior）の記入例（B-3）

### 参照（要求/要件）

- 要求: D-1（割り当ての見落としを減らす）
- 要件: R-1〜R-7

### 外部I/F（観測できる面）

- UI:
  - 管理者はタスク詳細で担当者を選択し「割り当て」を実行できる
  - 成功時に「割り当て完了」を表示し、担当者表示が更新される
- API（例）:
  - `POST /api/tasks/{taskId}/assignment` body: `{ "assigneeId": "user-123" }`
  - 成功時は `200` を返す
- 外部連携（通知）:
  - 割り当て時に担当者へ通知（メール）を送信する
  - メール送信の失敗/遅延が発生し得るため、失敗時の期待（業務継続/検知/再送）を定義する

### 受け入れ条件（Given/When/Then）

- Given: 管理者がログインしており、タスクが `todo` 状態で存在する
  - When: 管理者が担当者 `user-123` を割り当てる
  - Then:
    - タスクの `assigneeId` が `user-123` に更新される
    - 画面に「割り当て完了」が表示される
    - 担当者に「タスクが割り当てられた」旨の通知（メール）が送信される

- Given: 管理者がログインしており、対象タスクが存在しない
  - When: 管理者が割り当て操作を行う
  - Then:
    - API は `404` を返す
    - UI は「対象タスクが見つからない」旨を表示する
    - 監査/ログに「対象なし」が記録される（必要なら）

- Given: メール送信サービスが一時的に失敗する
  - When: 管理者が割り当て操作を行う
  - Then:
    - タスクの割り当て自体は成功する（業務継続を優先）
    - 送信失敗が運用で検知できる（ログ、メトリクス、アラートのいずれか）
    - 再送の方針（手動/自動）が明文化されている

### 例外系/失敗時の振る舞い（Behavior）

- 認可失敗:
  - 管理者以外が割り当て API を呼ぶと `403`（または同等）を返す
- 存在しない/不正入力:
  - `assigneeId` が不正な形式なら `400`（または同等）を返す
- 状態/業務ルール違反:
  - タスクが割り当て可能な状態でない場合（例: `done`）は `409`（または同等）を返す
- 競合（同時更新）:
  - 更新競合が発生した場合の扱いを固定する（例: `409`、または後勝ち。どちらでも良いが曖昧にしない）
- 外部I/F失敗（通知）:
  - 割り当て確定の合否と、通知送信の合否を混同しない（R-5）
  - 失敗の検知方法と再送の起点を固定する（ログ/キュー/手順）
- 冪等性（二重送信）:
  - 同一タスクに同一担当者を再割り当てしても、結果が重複しない（少なくとも監査ログや通知が増殖しない）
- 時間/期限:
  - 期限が過去の場合の扱い（許可/拒否/警告）を固定する（例: 割り当ては許可するが UI で警告する）
- 監査/ログ:
  - `403/404/400/409` 等の失敗も、原因追跡できる粒度で記録する（ただし個人情報をログに出さない）

### 観測点（何をもって合否判定するか）

- 画面表示: 担当者の表示が更新され、成功/失敗が表示できる
- API レスポンス: ステータスコード（200/403/404 等）とエラー形式（最低限 `code` と `message`）が一定
- 監査/ログ: 割り当てイベント（actor/task/assignee/時刻）と通知失敗が検索できる

### テスト観点（仕様から導出）

- 単体テストで守る振る舞い: 権限判定、状態遷移、期限ルールなど（純粋ロジック）
- 統合テストで守る契約（境界）: API+DB の永続化、認可接続、通知I/Fの失敗時の扱い
- E2E で守る導線: 管理者が割り当て、担当者表示が更新される（メール到達そのものはE2Eに含めない）

## D-4. 設計（Design / Structure）アウトラインの記入例（B-5）

### 参照（要求/要件/仕様）

- 要求: D-1
- 要件: R-1〜R-7
- 仕様: D-3

### 構造（境界と責務）

- domain:
  - 権限ルール（管理者のみ割り当て可）
  - 状態遷移（`todo → in_progress → done`）と割り当て可否
  - 期限判定（表示用ステータス等）
- usecases:
  - `assignTask`（割り当ての確定、通知要求、監査の記録）
  - 依存（DB/通知/時刻/認可）を port として引数で受ける
- adapters:
  - HTTP（ルーティング、入力検証、エラー形式）
  - DB（永続化、監査ログ）
  - mailer（外部メールI/F）

### 依存方向（ルール）

- domain は I/O やフレームワークに依存しない
- usecases は domain と port にのみ依存する
- adapters が port を実装し、外部 I/F（DB/メール等）を扱う

### データモデル

- 論理（概念/エンティティ）:
  - Task: `id/title/status/dueAt/assigneeId/assignedAt`
  - AssignmentAudit: `taskId/actorId/assigneeId/assignedAt`
- 物理（DB テーブル例）:
  - `tasks`: `id`, `title`, `status`, `due_at`, `assignee_id`, `assigned_at`
  - `audit_logs`: `id`, `action`, `task_id`, `actor_id`, `payload`, `created_at`

### 重要アルゴリズム/ルール

- 管理者のみ割り当て可能（認可は境界で enforce し、domain ルールとしても保持する）
- 完了済み（`done`）への割り当ては不可（例。運用要件に合わせて固定する）

### トレードオフ

- 得るもの: 割り当て確定と通知を分離でき、外部I/Fの失敗で業務確定が止まりにくい
- 失うもの: 通知が即時に届く保証は弱くなるため、検知と再送の運用が必要

### テスト戦略への影響

- domain は単体を厚く、adapters 境界は統合で守る
- E2E は価値導線に限定し、外部メール到達は含めない（フレーク源になりやすい）

## D-5. S/D/V 採点（依存関係トップ）の記入例（B-4）

例として、依存関係トップ 10 のうち代表的なものを記入します。

| # | 依存元 | 依存先 | 依存の内容 | S | D | V | コメント（観測/根拠） | 手当案 |
| ---: | --- | --- | --- | ---: | ---: | ---: | --- | --- |
| 1 | UI | API | 割り当て操作の入出力・エラー形式 | 4 | 3 | 3 | UI/API で入力検証・権限表示がズレると破綻 | 仕様（D-3）を固定 + 統合テスト |
| 2 | usecases | authz | 権限判定（管理者のみ割り当て可） | 4 | 3 | 3 | 認可ルール変更が UI/API に波及しやすい | 判定を domain 側へ寄せ、単体で守る |
| 3 | usecases | db | 割り当ての永続化と監査ログ | 4 | 3 | 2 | 同時変更は必須、ただし変動性は低め | schema/DAO を境界に固定 + 統合テスト |
| 4 | usecases | mailer | 割り当て通知の送信 | 2 | 4 | 3 | 外部I/Fで失敗が起きる、運用要件が増えやすい | adapter 化 + 失敗時の扱いを ADR 化 |

採点の狙い:

- 「今すぐ手当すべき」ものは、S と D と V が同時に悪い領域になりやすい
- ただし S が強い領域は「分離」より「一体で扱う」ほうがコストが低い場合がある（章 03 の判断原則）

## D-6. Change Drivers（記入例）（B-6）

### 対象: 「通知を境界として強める」

#### 背景（何が起きているか）

- 事象（観測）: 通知失敗が顕在化し、問い合わせが発生した
- 影響（価値/運用/コスト）: 担当者が気づかず、期限超過が増える
- 期限（いつまでに）: 次のリリースまでに検知手段を用意したい

#### ドライバー（何が変更を必要にしているか）

| ドライバー | 内容 | 強さ（低/中/高） | 根拠 |
| --- | --- | --- | --- |
| 変動性（V） | 通知要件が増える | 中 | 追加要望（再送/テンプレ）が出ている |
| 距離（D） | 外部メール I/F | 高 | 失敗/遅延が発生する |
| 統合強度（S） | 割り当て確定は必須 | 高 | 業務確定のため |
| 運用要件 | 失敗検知が必要 | 高 | 問い合わせが発生した |
| チーム/組織 | 単一チーム | 低 | 現時点では分割不要 |

#### 対応方針（案）

- 何を変える: 通知を adapter として明確化し、失敗を検知できる形にする
- 変えないこと（非ゴール）: 高度な配信保証、複数チャネル対応
- テスト戦略への影響: 通知は統合テスト中心、E2E には入れない
- ADR が必要か: 必要（通知の扱いは重大な分岐）

## D-7. ADR（記入例）（B-7）

### ADR: 通知（メール）失敗時の扱いを「業務継続優先」にする

- Status: accepted
- Date: 2026-01-12
- Deciders: 開発チーム
- Scope: タスク割り当て/通知

#### Context

- 背景: 割り当て時に通知（メール）が必要になった
- 問題: メール送信は外部 I/F であり、失敗/遅延が発生する
- 制約: 割り当ては業務上の確定であり、通知失敗で割り当て自体を失敗させたくない

#### Decision

- 採用する決定: 割り当ての永続化は成功させ、通知失敗は「検知 + 再送方針」で扱う
- 理由: D が大きい外部 I/F である一方、割り当ての S は強い（同時変更が必須）。境界（adapter）で失敗を吸収し、ユースケースは業務確定を優先する

#### Consequences

- 得られる効果: 業務フローが外部障害に引きずられにくい
- 失うもの/トレードオフ: 「通知が届いていない」可能性が残るため、運用で検知する必要がある
- 後続タスク: 失敗ログ/メトリクス整備、再送手順の明文化
- 見直し条件: 通知が SLA 対象になった、または失敗が頻発した場合

## D-8. テスト配分（記入例）（B-8）

### 対象: 「タスク割り当て + 通知（メール）」

#### 方針（ねらい）

- 価値導線: 管理者が割り当て、担当者が着手/完了できること
- 主要リスク: 権限漏れ、割り当て不整合、通知失敗の検知漏れ
- 許容できない障害: 権限逸脱、データ不整合（割り当てが失われる）

#### 配分（例）

| レベル | ねらい | 対象 | 備考 |
| --- | --- | --- | --- |
| 単体 | コアの振る舞い保護 | 権限判定、状態遷移、期限判定 | 時刻は注入して固定 |
| 統合 | 境界の契約保護 | API+DB、認可、通知 I/F（失敗時の扱い） | 外部メールは stub/spy で契約固定 |
| E2E | 価値導線の保護 | 管理者が割り当て、担当者表示が更新される | メール到達は含めない |

#### 対象別の分類（例）

| 対象 | 単体 | 統合 | E2E | 補足 |
| --- | --- | --- | --- | --- |
| 権限判定 | ○ | ○ | △ | 主要導線で E2E も可 |
| DB 永続化 | - | ○ | △ | schema/クエリの契約を守る |
| 通知（メール） | - | ○ | - | 外部 I/F は統合で stub 化 |
| 主要導線（割り当て） | - | △ | ○ | E2E は少数精鋭 |

配分の目安（例）:

- 単体 20 / 統合 10 / E2E 3

## 前後リンク

- [目次]({{ '/chapters/' | relative_url }})
- [前: Appendix B（テンプレ集）]({{ '/appendix/B-templates/' | relative_url }})
- [次: Appendix E（用語集）]({{ '/appendix/E-glossary/' | relative_url }})
