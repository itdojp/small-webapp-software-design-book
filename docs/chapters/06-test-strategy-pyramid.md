---
title: "06. テスト戦略（単体/統合/E2E）"
permalink: /chapters/06-test-strategy-pyramid/
show_nav: true
prev: /chapters/05-design-for-testability/
next: /chapters/07-evolution-and-adr/
---

# 06. テスト戦略（単体/統合/E2E）

## 目的

- 単体/統合/E2E を「量の議論」ではなく、複雑さと価値導線に応じて配分する
- 壊れにくさ（変更耐性）を高めるための最小戦略を確立する

## 得られる判断能力

- 小規模における「現実的なテスト配分」を説明できる（ピラミッドを盲信しない）
- 価値導線に E2E を割り当て、境界を統合テストで守る設計ができる
- 変更頻度（V）と距離（D）を踏まえて、投資先（単体/統合）を決められる

## 前提/用語

- **単体テスト**: 小さい単位（関数/モジュール）で振る舞いを検証
- **統合テスト**: 境界を跨ぐ結合（DB、HTTP、状態管理など）を検証
- **E2E**: ユーザー導線として価値を提供できることを検証

## 要点

- E2E は少数精鋭で良いが、価値導線を外してはいけない
- 統合テストは「境界の契約」を守る。変更頻度と D（距離）が大きいほど重要になる
- 単体テストは「コア」の変更耐性を支える。V（変動性）が高い領域ほど意味が出る

## 例（ランニング例）

タスク管理を例にすると、配分の考え方は次の通りです。

- 単体（厚め）:
  - 期限判定、状態遷移、入力バリデーション
  - 権限判定ロジック（ロール/所有者のルール）
- 統合（境界を守る）:
  - API + DB（永続化と取得）
  - 認可（ミドルウェア/ガード）とユースケースの接続
  - 通知I/F（失敗時の扱い、リトライ）
- E2E（主要導線のみ）:
  - 管理者がタスクを作成し、担当者に割り当てる
  - 担当者がタスクを完了する
  - 期限超過の表示/通知（重要なら）

配分の目安（例）:

- 単体 20 / 統合 10 / E2E 3（数字は目安。価値導線と複雑さで調整する）

## 演習（最小1個）

ランニング例の機能一覧から、次を分類してください（Appendix B のテンプレ利用）。

1. 単体で守るもの
2. 統合で守るもの
3. E2E で守るもの（主要導線のみ）

- [Appendix B: テンプレ集]({{ '/appendix/B-templates/' | relative_url }})
- 記入例: [Appendix D: 記入例]({{ '/appendix/D-samples/' | relative_url }})

## よくある失敗

- E2E を増やして安心しようとし、実行時間と不安定さで破綻する
- 統合ポイント（API、DB、認可）を単体で誤魔化し、本番で壊れる
- テストが仕様の代替になり、要件の合意が曖昧なまま進む

## チェックリスト

- [ ] 価値導線（ユーザー価値）に E2E が割り当てられている
- [ ] 境界（API/DB/認可）の契約が統合テストで検証されている
- [ ] 単体テストがコアの振る舞いを守っている（実装詳細に依存しない）

## 前後リンク

- [目次]({{ '/chapters/' | relative_url }})
- [前章: 05. 設計時にテストを織り込む]({{ '/chapters/05-design-for-testability/' | relative_url }})
- [次章: 07. 進化条件（ADRと境界の強化タイミング）]({{ '/chapters/07-evolution-and-adr/' | relative_url }})
